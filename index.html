<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wichteln 2025 – Los ziehen</title>
  <style>
    html, body {
      width: 100%;
      height: 100vh;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      font-family: Arial, sans-serif;
      color: #333;
    }
    body { overflow-y: auto; }

    .content-area { background: white; padding: 8px 20px; position: relative; z-index: 2; }

    .background-area {
      background: url('images/background.jpg') no-repeat center top;
      background-size: cover;
      height: 100vh;
      position: relative;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding: 20px;
      box-sizing: border-box;
      width: 100%;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      width: 100%;
      box-sizing: border-box;
    }

    h1 { font-size: 2em; margin: 5px 0 8px; }
    h2 { font-size: 1.3em; margin-bottom: 15px; }

    button {
      margin: 15px;
      padding: 12px 24px;
      font-size: 1.2em;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      background-color: rgba(255, 0, 0, 0.85);
      color: white;
      transition: background-color 0.3s ease;
    }

    button:hover { background-color: rgba(200,0,0,0.95); }
    button:disabled { background: #bdc3c7; cursor: not-allowed; }

    #drawArea {
      font-size: 1.5em;
      font-weight: bold;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 15px 0;
    }

    #admin, #admin-login { 
      margin-bottom: 40px; 
      padding: 20px; 
      background: #f8f9fa; 
      border-radius: 10px; 
      border: 2px solid #e9ecef; 
    }

    #admin-login input {
      padding: 10px 15px;
      font-size: 1.1em;
      border: 2px solid #ddd;
      border-radius: 5px;
      margin: 10px;
      text-align: center;
    }

    #links a { display:block; margin:8px 0; padding:10px 15px; background:#3498db; color:white; text-decoration:none; border-radius:5px;}
    #links a:hover { background:#2980b9; }

    @media (max-width: 600px) {
      .container { padding: 10px; }
      h1 { font-size:1.4em; }
      h2 { font-size:1.2em; }
      button { font-size:1em; padding:10px 20px; margin:10px 5px; }
    }
  </style>
</head>
<body>
  <div class="content-area">
    <div class="container">
      <h1>Wichteln 2025</h1>
      <div id="admin-login">
        <h2>Admin-Zugang</h2>
        <input type="password" id="admin-password" placeholder="Passwort eingeben">
        <br>
        <button id="admin-login-btn">Einloggen</button>
        <div id="login-error" style="color:red; margin-top:10px; display:none;">Falsches Passwort!</div>
      </div>

      <div id="admin" style="display:none;">
        <h2>Admin-Bereich</h2>
        <button id="generateBtn">Zuweisungen erstellen</button>
        <div id="links"></div>
        <div id="pulled-status"></div>
      </div>
    </div>
  </div>

  <div class="background-area">
    <div class="draw-container">
      <div id="participant">
        <div id="drawArea"></div>
        <button id="drawBtn">Los ziehen</button>
      </div>
    </div>
  </div>

<script>
const participants = ["Jens","Susanne","Claus","Inga","Ole","Caroline","Henrik","Annbritt"];
const fixedGiver = "Jens";
const fixedReceiver = "Susanne";
const forbiddenPairs = [
  ["Claus","Susanne"], ["Susanne","Claus"],
  ["Ole","Inga"], ["Inga","Ole"],
  ["Henrik","Annbritt"], ["Annbritt","Henrik"],
  ["Caroline","Jens"], ["Jens","Caroline"]
];

document.addEventListener('DOMContentLoaded', function() {
  const urlParams = new URLSearchParams(window.location.search);
  const tokenParam = urlParams.get("token");

  if(tokenParam){
    initParticipantMode(tokenParam);
  } else {
    initAdminMode();
  }

  function initParticipantMode(token){
    const drawArea = document.getElementById("drawArea");
    const drawBtn = document.getElementById("drawBtn");

    const tokenData = decodeTokenToAssignment(token);
    const giver = tokenData?.giver;
    const receiver = tokenData?.receiver;

    if(!giver || !receiver){
        drawArea.innerText="Ungültiger Link!";
        drawBtn.style.display='none';
        return;
    }

    document.getElementById('admin').style.display='none';
    document.getElementById('admin-login').style.display='none';

    drawBtn.addEventListener("click", ()=>{
        drawBtn.disabled=true;

        const pulledTokens = JSON.parse(localStorage.getItem("pulledTokens")||"{}");
        pulledTokens[giver]={pulled:true,timestamp:new Date().toISOString()};
        localStorage.setItem("pulledTokens", JSON.stringify(pulledTokens));

        drawArea.style.background="rgba(255,255,255,0.8)";
        drawArea.style.borderRadius="10px";
        drawArea.style.padding="15px";

        setTimeout(()=>{
            drawArea.innerText = receiver;
            drawArea.style.color="#ff0000";
            drawArea.style.fontSize="2.5em";
        },200);
    });
  }

  function initAdminMode(){
    const adminPassword = document.getElementById('admin-password');
    const adminLoginBtn = document.getElementById('admin-login-btn');
    const loginError = document.getElementById('login-error');
    const adminSection = document.getElementById('admin');
    const adminLoginSection = document.getElementById('admin-login');

    document.getElementById('participant').style.display='none';

    adminLoginBtn.addEventListener('click', checkPassword);
    adminPassword.addEventListener('keypress', function(e){
        if(e.key==='Enter') checkPassword();
    });

    function checkPassword() {
        if(adminPassword.value==='Jens'){
            adminLoginSection.style.display='none';
            adminSection.style.display='block';
            loginError.style.display='none';
            sessionStorage.setItem('admin-logged-in','true');
            updatePulledStatus();
            setInterval(updatePulledStatus,15000);
        } else {
            loginError.style.display='block';
            adminPassword.value='';
            adminPassword.focus();
        }
    }

    if(sessionStorage.getItem('admin-logged-in')==='true'){
        adminLoginSection.style.display='none';
        adminSection.style.display='block';
        updatePulledStatus();
        setInterval(updatePulledStatus,15000);
    }

    const generateBtn = document.getElementById("generateBtn");
    if(generateBtn){
      generateBtn.addEventListener("click", function(){
        const assignments = generateAssignments();
        const seed = Date.now();
        const linksDiv = document.getElementById("links");
        linksDiv.innerHTML = "<h3>Teilnehmer-Links:</h3><p>Teile diese Links mit den jeweiligen Personen:</p>";

        for(const [giver, receiver] of Object.entries(assignments)){
          const linkWrapper = document.createElement("div");
          linkWrapper.style.marginBottom="10px";
          const label = document.createElement("strong");
          label.innerText = giver+": ";
          const link = document.createElement("a");
          const secureToken = createTokenFromAssignment(giver, receiver, seed);
          link.href=`${window.location.origin}${window.location.pathname}?token=${secureToken}`;
          link.target="_blank";
          link.innerText="Los ziehen";
          linkWrapper.appendChild(label);
          linkWrapper.appendChild(link);
          linksDiv.appendChild(linkWrapper);
        }
        generateBtn.innerText="Zuweisungen erstellt!";
        generateBtn.disabled=true;
        setTimeout(()=>{generateBtn.innerText="Neue Zuweisungen erstellen"; generateBtn.disabled=false;},5000);
      });
    }
  }

  function generateAssignments(){
    const assignments = {};
    let availableReceivers = participants.slice();
    assignments[fixedGiver] = fixedReceiver;
    availableReceivers.splice(availableReceivers.indexOf(fixedReceiver),1);

    const remainingGivers = participants.filter(p=>p!==fixedGiver);

    for(let giver of remainingGivers){
      let possibleReceivers = availableReceivers.filter(r=>{
        if(r===giver) return false;
        if(forbiddenPairs.some(pair=>pair[0]===giver && pair[1]===r)) return false;
        if(assignments[r]===giver) return false;
        return true;
      });

      if(possibleReceivers.length===0) return generateAssignments();
      const receiver = possibleReceivers[Math.floor(Math.random()*possibleReceivers.length)];
      assignments[giver]=receiver;
      availableReceivers.splice(availableReceivers.indexOf(receiver),1);
    }
    return assignments;
  }

  function createTokenFromAssignment(giver, receiver, seed){
    const giverIndex = participants.indexOf(giver);
    const receiverIndex = participants.indexOf(receiver);
    const combined = (giverIndex<<4)|receiverIndex;
    const tokenPart = combined.toString(36).padStart(2,'0');
    const seedPart = seed.toString(36).substr(2,6);
    return seedPart+tokenPart+Math.random().toString(36).substr(2,4);
  }

  function decodeTokenToAssignment(token){
    try{
      const tokenPart = token.substr(6,2);
      const combined = parseInt(tokenPart,36);
      const giverIndex=(combined>>4)&0xF;
      const receiverIndex=combined&0xF;
      if(giverIndex>=0&&giverIndex<participants.length && receiverIndex>=0&&receiverIndex<participants.length){
        return {giver:participants[giverIndex],receiver:participants[receiverIndex]};
      }
    } catch(e){ console.error(e); }
    return null;
  }

  function updatePulledStatus(){
    const pulledTokens = JSON.parse(localStorage.getItem("pulledTokens")||"{}");
    let statusDiv = document.getElementById("pulled-status");
    if(!statusDiv){
      statusDiv=document.createElement("div");
      statusDiv.id="pulled-status";
      statusDiv.style.marginTop="20px";
      statusDiv.innerHTML="<h3>Teilnehmer, die bereits gezogen haben:</h3>";
      const ul=document.createElement("ul");
      statusDiv.appendChild(ul);
      document.getElementById("admin").appendChild(statusDiv);
    }
    const ul=statusDiv.querySelector("ul");
    ul.innerHTML="";
    for(const p of participants){
      const li=document.createElement("li");
      if(pulledTokens[p]?.pulled){
        const date=new Date(pulledTokens[p].timestamp);
        li.innerText=`${p} (gezogen am ${date.toLocaleString()})`;
      } else li.innerText="-";
      ul.appendChild(li);
    }
  }
});
</script>
</body>
</html>
